namespace: TypoScript=TYPO3.TypoScript
namespace: Neos=TYPO3.Neos
namespace: Youtube=Jonnitto.PrettyEmbedYoutube

prototype(Youtube:ImageUri) < prototype(Neos:ImageUri) {
	asset = ${q(node).property('customPreviewImage')}
	maximumWidth = ${maximumWidth}
	@if.hasPicture = ${q(node).property('customPreviewImage') ? true : false}
}

prototype(Youtube:ImageSrc) < prototype(TypoScript:Array) {
	youtubeImage = ${'//img.youtube.com/vi/' + q(node).property('videoID') + '/' + configuration.imgResultion + '.jpg'}
	youtubeImage.@if.hasNoPicture = ${q(node).property('customPreviewImage') ? false : true}
	customPreviewImage = Youtube:ImageUri
}

prototype(Youtube:ImageSrcRetina) < prototype(Youtube:ImageUri) {
	maximumWidth = ${maximumWidth * 2}
}

prototype(Youtube:YouTube) < prototype(Neos:Content) {
	@context.configuration = ${Configuration.setting('Jonnitto.PrettyEmbedYoutube')}
	@context.type = ${q(node).property('type') ? q(node).property('type') : 'video'}

	isPlaylistANDnoImage = ${type == 'playlist' && !q(node).property('customPreviewImage')}

	@context.maximumWidth = ${this.maximumWidth ? this.maximumWidth : configuration.maximumWidth}

	wrapper = ${configuration.wrapper ? configuration.wrapper : false}

	tagName = ${node.context.live ? 'a' : 'div'}
	attributes {
		class = TypoScript:RawArray {
			@process.nodeType >
			nodeType = 'jonnitto-prettyembedyoutube-youtube'
			lightbox = ${q(node).property('lightbox') ? configuration.lightbox.class : configuration.embed.class}
		}
		data-fs = ${q(node).property('allowFullScreen') ? 'true' : 'false'}
		data-embed = TypoScript:Array {
			src            = ${configuration.embed[type]}
			videoID        = ${q(node).property('videoID')}
			var            = ${type == 'video' ? '?' : '&'}
			autoplay       = 'autoplay=1'
			showinfo       = ${q(node).property('showInfo') ? '' : '&showinfo=0'}
			showControls   = ${q(node).property('showControls') ? '' : '&controls=0'}
			loop           = ${q(node).property('loop') ? '&loop=1' : ''}
			closedCaptions = ${q(node).property('closedCaptions') ? '&cc_load_policy=1' : ''}
			showRelated    = ${q(node).property('showRelated') ? '&rel=1' : '&rel=0'}
		}
		href = ${configuration.lightbox[type] + q(node).property('videoID')}
		target = '_blank'
	}

	content = TypoScript:Tag {
		tagName = 'img'
		attributes {
			src = Youtube:ImageSrc
			data-src-retina = Youtube:ImageSrcRetina
		}
	}
}

prototype(Neos:Page) {
	head.prettyEmbedYoutube = TypoScript:Tag {
		tagName = 'link'
		attributes {
			rel = 'stylesheet'
			href = TypoScript:ResourceUri {
				path = 'resource://Jonnitto.PrettyEmbedYoutube/Public/Main.css'
			}
		}
		@if.hasVideoOrIsBackendAndActive = ${(q(node).children('[instanceof TYPO3.Neos:ContentCollection]').find('[instanceof Jonnitto.PrettyEmbedYoutube:YouTube]').is() || node.context.inBackend) && Configuration.setting('Jonnitto.PrettyEmbedYoutube.includeCss')}
	}
	body.javascripts.prettyEmbedYoutube = TypoScript:Tag {
		tagName = 'script'
		attributes.src = TypoScript:ResourceUri {
			path = 'resource://Jonnitto.PrettyEmbedYoutube/Public/Main.js'
		}
		@position = 'end'
		@if.hasVideoAndIsLiveAndActive = ${q(node).children('[instanceof TYPO3.Neos:ContentCollection]').find('[instanceof Jonnitto.PrettyEmbedYoutube:YouTube]').is() && node.context.live && Configuration.setting('Jonnitto.PrettyEmbedYoutube.includeJavascript')}
	}
}
